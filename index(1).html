<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rate Your Teacher</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Unbounded:wght@500;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --night: #05040c;
      --night-soft: #0c0b1f;
      --ice: #7df9ff;
      --violet: #a478ff;
      --peach: #ff8bd3;
      --mint: #7bffb0;
      --text: #f5f7ff;
      --muted: rgba(245, 247, 255, 0.6);
      --border: rgba(125, 249, 255, 0.2);
      --success: #6ee7b7;
      --error: #fca5a5;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(125, 249, 255, 0.2), transparent 50%),
        radial-gradient(circle at 80% 0%, rgba(164, 120, 255, 0.2), transparent 45%),
        linear-gradient(120deg, #04030a 0%, #080617 40%, #120b2a 100%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      background-size: 200% 200%;
      animation: gradientFlow 16s ease infinite;
    }

    .ambient-orbs {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .ambient-orbs span {
      position: absolute;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      filter: blur(20px);
      opacity: 0.35;
      animation: float 12s ease-in-out infinite;
    }

    .ambient-orbs span:nth-child(1) {
      background: var(--violet);
      top: 8%;
      left: -5%;
    }

    .ambient-orbs span:nth-child(2) {
      background: var(--ice);
      top: 55%;
      right: -6%;
      animation-delay: -4s;
    }

    .ambient-orbs span:nth-child(3) {
      background: var(--peach);
      bottom: -10%;
      left: 30%;
      animation-delay: -7s;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      position: relative;
      z-index: 1;
    }

    .header {
      background: rgba(5, 7, 18, 0.75);
      border-bottom: 1px solid var(--border);
      padding: 20px 0;
      margin-bottom: 30px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(16px);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .logo {
      font-family: 'Unbounded', sans-serif;
      font-size: 24px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text);
      display: inline-flex;
      gap: 10px;
      align-items: center;
    }

    .logo::before {
      content: '‚ú¶';
      color: var(--ice);
      text-shadow: 0 0 18px rgba(125, 249, 255, 0.6);
    }

    .auth-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      position: relative;
      z-index: 1;
    }

    .auth-card {
      background: rgba(6, 8, 22, 0.8);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 42px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 70px rgba(4, 4, 12, 0.8);
      backdrop-filter: blur(20px);
      animation: popIn 0.8s ease;
    }

    .auth-title {
      font-family: 'Unbounded', sans-serif;
      font-size: 26px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 28px;
      letter-spacing: 0.05em;
    }

    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(6, 8, 22, 0.9);
      border: 1px solid rgba(125, 249, 255, 0.2);
      border-radius: 14px;
      color: var(--text);
      font-size: 15px;
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--ice);
      box-shadow: 0 0 0 3px rgba(125, 249, 255, 0.2);
      transform: translateY(-1px);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .btn {
      width: 100%;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--ice) 0%, var(--violet) 60%, var(--peach) 100%);
      color: #05040c;
      border: none;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transform: translateX(-120%);
      transition: transform 0.5s ease;
    }

    .btn:hover::after {
      transform: translateX(120%);
    }

    .btn:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 12px 28px rgba(125, 249, 255, 0.35);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(125, 249, 255, 0.4);
      margin-top: 12px;
    }

    .btn-secondary:hover {
      background: rgba(125, 249, 255, 0.12);
    }

    .btn-small {
      width: auto;
      padding: 8px 18px;
      font-size: 12px;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px;
      background: rgba(8, 10, 24, 0.7);
      color: var(--muted);
      border: 1px solid transparent;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: auto;
    }

    .tab:hover {
      color: var(--text);
      border-color: rgba(125, 249, 255, 0.3);
    }

    .tab.active {
      color: var(--text);
      border-color: rgba(125, 249, 255, 0.6);
      box-shadow: 0 0 20px rgba(125, 249, 255, 0.2);
    }

    .tab-content {
      display: none;
      animation: fadeUp 0.6s ease;
    }

    .tab-content.active {
      display: block;
    }

    .teachers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }

    .teacher-card {
      background: rgba(8, 10, 24, 0.8);
      border: 1px solid rgba(125, 249, 255, 0.16);
      border-radius: 18px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.35s ease;
      position: relative;
    }

    .teacher-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 0%, rgba(125, 249, 255, 0.2), transparent 55%);
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .teacher-card:hover::before {
      opacity: 1;
    }

    .teacher-card:hover {
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 24px 60px rgba(5, 7, 18, 0.8);
      border-color: rgba(125, 249, 255, 0.5);
    }

    .teacher-image-container {
      width: 100%;
      padding-top: 100%;
      position: relative;
      background: rgba(4, 6, 16, 0.9);
      border-bottom: 1px solid rgba(125, 249, 255, 0.15);
    }

    .teacher-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.1);
      transition: transform 0.4s ease;
    }

    .teacher-card:hover .teacher-image {
      transform: scale(1.04);
    }

    .teacher-rating-badge {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: rgba(4, 6, 16, 0.85);
      backdrop-filter: blur(10px);
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(125, 249, 255, 0.4);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 700;
      color: var(--ice);
      box-shadow: 0 0 20px rgba(125, 249, 255, 0.2);
    }

    .teacher-info {
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    .teacher-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .teacher-qualifications {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(4, 5, 14, 0.85);
      backdrop-filter: blur(6px);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: rgba(8, 10, 24, 0.85);
      border: 1px solid rgba(125, 249, 255, 0.2);
      border-radius: 20px;
      padding: 32px;
      width: 100%;
      max-width: 720px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: popIn 0.6s ease;
    }

    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(4, 6, 16, 0.9);
      border: 1px solid rgba(125, 249, 255, 0.2);
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.3s ease;
    }

    .close-modal:hover {
      background: rgba(125, 249, 255, 0.2);
      color: var(--ice);
    }

    .modal-header {
      display: flex;
      gap: 24px;
      margin-bottom: 30px;
      padding-bottom: 24px;
      border-bottom: 1px solid rgba(125, 249, 255, 0.1);
    }

    .modal-image-container {
      width: 160px;
      height: 160px;
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(4, 6, 16, 0.9);
      border: 1px solid rgba(125, 249, 255, 0.2);
      flex-shrink: 0;
    }

    .modal-teacher-name {
      font-family: 'Unbounded', sans-serif;
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .modal-qualifications {
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .stars-display {
      font-size: 24px;
      color: var(--ice);
      margin-bottom: 8px;
      text-shadow: 0 0 18px rgba(125, 249, 255, 0.4);
    }

    .ratings-count {
      font-size: 13px;
      color: var(--muted);
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--ice);
    }

    .stars-input {
      display: flex;
      gap: 10px;
      font-size: 32px;
      margin-bottom: 20px;
    }

    .star {
      cursor: pointer;
      color: rgba(125, 249, 255, 0.2);
      transition: all 0.2s;
    }

    .star.active {
      color: var(--ice);
      text-shadow: 0 0 12px rgba(125, 249, 255, 0.4);
    }

    .star:hover {
      transform: scale(1.15) rotate(-3deg);
    }

    .review {
      background: rgba(4, 6, 16, 0.8);
      border: 1px solid rgba(125, 249, 255, 0.12);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .review.my-review {
      border-color: rgba(125, 249, 255, 0.5);
      background: rgba(125, 249, 255, 0.08);
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .review-user {
      font-weight: 600;
    }

    .review-date {
      font-size: 12px;
      color: var(--muted);
    }

    .review-text {
      line-height: 1.6;
    }

    .discussion-message {
      background: rgba(4, 6, 16, 0.8);
      border: 1px solid rgba(125, 249, 255, 0.12);
      border-left: 3px solid var(--ice);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: transform 0.3s ease;
    }

    .discussion-message:hover {
      transform: translateY(-2px);
    }

    .discussion-message.pinned {
      border-left-color: var(--peach);
      background: rgba(255, 139, 211, 0.1);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .message-user {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .message-time {
      font-size: 12px;
      color: var(--muted);
    }

    .message-text {
      line-height: 1.6;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 13px;
      border: 1px solid;
      animation: pulse 2s infinite;
    }

    .alert-error {
      background: rgba(252, 165, 165, 0.12);
      border-color: rgba(252, 165, 165, 0.5);
      color: var(--error);
    }

    .alert-success {
      background: rgba(110, 231, 183, 0.12);
      border-color: rgba(110, 231, 183, 0.5);
      color: var(--success);
    }

    .text-center {
      text-align: center;
    }

    .mt-2 {
      margin-top: 8px;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(4, 6, 16, 0.9);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(125, 249, 255, 0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(125, 249, 255, 0.5);
    }

    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    @keyframes popIn {
      from { transform: translateY(20px) scale(0.96); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 rgba(125, 249, 255, 0); }
      50% { box-shadow: 0 0 20px rgba(125, 249, 255, 0.25); }
    }

    @media (max-width: 768px) {
      .teachers-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }

      .modal-header {
        flex-direction: column;
      }

      .modal-image-container {
        width: 100%;
        height: 200px;
      }

      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="ambient-orbs" aria-hidden="true">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <div id="app"></div>

  <script>
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://your-render-backend-url.onrender.com';

    let token = localStorage.getItem('token');
    let currentUser = null;
    let currentTab = 'teachers';

    async function register(username, password) {
      const response = await fetch(`${API_URL}/api/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      token = data.token;
      localStorage.setItem('token', token);
      currentUser = data.user;
      return data;
    }

    async function login(username, password) {
      const response = await fetch(`${API_URL}/api/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      token = data.token;
      localStorage.setItem('token', token);
      currentUser = data.user;
      return data;
    }

    function logout() {
      token = null;
      localStorage.removeItem('token');
      currentUser = null;
      render();
    }

    async function setupAccount(schoolId, classId) {
      const response = await fetch(`${API_URL}/api/setup`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ schoolId, classId })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      currentUser.isSetup = true;
      return data;
    }

    async function fetchSchools() {
      const response = await fetch(`${API_URL}/api/schools`);
      return response.json();
    }

    async function fetchClasses(schoolId) {
      const response = await fetch(`${API_URL}/api/schools/${schoolId}/classes`);
      return response.json();
    }

    async function fetchTeachers() {
      const response = await fetch(`${API_URL}/api/teachers`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function fetchReviews(teacherId) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/reviews`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function fetchMyReview(teacherId) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/my-review`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function postReview(teacherId, text) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/reviews`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ text })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      return data;
    }

    async function updateReview(reviewId, text) {
      const response = await fetch(`${API_URL}/api/reviews/${reviewId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ text })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      return data;
    }

    async function fetchMyRating(teacherId) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/my-rating`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function postRating(teacherId, rating) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/ratings`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ rating })
      });
      return response.json();
    }

    async function fetchDiscussions() {
      const response = await fetch(`${API_URL}/api/discussions`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function postDiscussion(message) {
      const response = await fetch(`${API_URL}/api/discussions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ message })
      });
      return response.json();
    }

    function AuthPage() {
      return `
        <div class="auth-page">
          <div class="auth-card">
            <h1 class="auth-title">‚≠ê Rate Your Teacher</h1>
            <div id="auth-error"></div>
            <form id="auth-form">
              <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" required autocomplete="username" />
              </div>
              <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" required autocomplete="current-password" />
              </div>
              <button type="submit" class="btn">Login</button>
              <button type="button" class="btn btn-secondary" id="register-btn">Create Account</button>
            </form>
          </div>
        </div>
      `;
    }

    function SetupPage() {
      return `
        <div class="auth-page">
          <div class="auth-card">
            <h2 class="auth-title">Complete Setup</h2>
            <div id="setup-error"></div>
            <form id="setup-form">
              <div class="form-group">
                <label>Select Your School</label>
                <select id="school-select" required>
                  <option value="">Loading...</option>
                </select>
              </div>
              <div class="form-group">
                <label>Select Your Class</label>
                <select id="class-select" required disabled>
                  <option value="">First select a school</option>
                </select>
              </div>
              <button type="submit" class="btn">Complete Setup</button>
            </form>
          </div>
        </div>
      `;
    }

    function MainPage() {
      return `
        <div class="header">
          <div class="header-content">
            <div class="logo">‚≠ê Rate Your Teacher</div>
            <button class="btn btn-small" onclick="logout()">Logout</button>
          </div>
        </div>
        
        <div class="container">
          <div class="tabs">
            <button class="tab ${currentTab === 'teachers' ? 'active' : ''}" onclick="switchTab('teachers')">Teachers</button>
            <button class="tab ${currentTab === 'discussions' ? 'active' : ''}" onclick="switchTab('discussions')">Discussions</button>
          </div>

          <div id="teachers-tab" class="tab-content ${currentTab === 'teachers' ? 'active' : ''}">
            <div class="teachers-grid" id="teachers-grid"></div>
          </div>

          <div id="discussions-tab" class="tab-content ${currentTab === 'discussions' ? 'active' : ''}">
            <div class="form-group">
              <textarea id="discussion-input" placeholder="Share your thoughts..."></textarea>
              <button class="btn mt-2" onclick="postNewDiscussion()">Post Message</button>
            </div>
            <div id="discussions-list" style="margin-top: 24px;"></div>
          </div>
        </div>

        <div id="teacher-modal" class="modal"></div>
      `;
    }

    function TeacherCard(teacher) {
      const imageContent = teacher.imageUrl 
        ? `<img src="${teacher.imageUrl}" alt="${teacher.name}" class="teacher-image" />`
        : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">No Image</div>';
      
      return `
        <div class="teacher-card" onclick="openTeacherModal('${teacher._id}')">
          <div class="teacher-image-container">
            ${imageContent}
            <div class="teacher-rating-badge">
              <span>${teacher.averageRating.toFixed(1)}</span>
              <span>‚òÖ</span>
            </div>
          </div>
          <div class="teacher-info">
            <div class="teacher-name">${teacher.name}</div>
            <div class="teacher-qualifications">${teacher.qualifications}</div>
          </div>
        </div>
      `;
    }

    function TeacherModal(teacher, reviews, myReview, myRating) {
      const stars = '‚òÖ'.repeat(Math.round(teacher.averageRating)) + '‚òÜ'.repeat(5 - Math.round(teacher.averageRating));
      const imageContent = teacher.imageUrl 
        ? `<img src="${teacher.imageUrl}" alt="${teacher.name}" class="teacher-image" />`
        : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">No Image</div>';
      
      return `
        <div class="modal-content">
          <button class="close-modal" onclick="closeTeacherModal()">√ó</button>
          
          <div class="modal-header">
            <div class="modal-image-container">
              ${imageContent}
            </div>
            <div style="flex: 1;">
              <h2 class="modal-teacher-name">${teacher.name}</h2>
              <p class="modal-qualifications">${teacher.qualifications}</p>
              <div class="stars-display">${stars}</div>
              <p class="ratings-count">${teacher.totalRatings} rating${teacher.totalRatings !== 1 ? 's' : ''}</p>
            </div>
          </div>

          <div class="section">
            <h3 class="section-title">Your Rating</h3>
            <div class="stars-input">
              ${[1, 2, 3, 4, 5].map(i => `
                <span class="star ${i <= (myRating?.rating || 0) ? 'active' : ''}" onclick="rateTeacher('${teacher._id}', ${i})">‚òÖ</span>
              `).join('')}
            </div>
          </div>

          <div class="section">
            <h3 class="section-title">Reviews</h3>
            
            ${myReview ? `
              <div class="review my-review">
                <div class="review-header">
                  <span class="review-user">Your Review</span>
                  <button class="btn btn-small" onclick="editMyReview('${myReview._id}', '${teacher._id}')">Edit</button>
                </div>
                <div class="review-text">${myReview.text}</div>
              </div>
            ` : `
              <div class="form-group">
                <textarea id="review-input" placeholder="Write your review..."></textarea>
                <button class="btn mt-2" onclick="submitReview('${teacher._id}')">Post Review</button>
              </div>
            `}

            ${reviews.length > 0 ? '<h4 class="section-title" style="margin-top: 24px;">All Reviews</h4>' : ''}
            ${reviews.length === 0 ? '<p style="color: var(--text-muted);">No reviews yet.</p>' : ''}
            ${reviews.map(review => `
              <div class="review">
                <div class="review-header">
                  <span class="review-user">${review.username}</span>
                  <span class="review-date">${new Date(review.createdAt).toLocaleDateString()}</span>
                </div>
                <div class="review-text">${review.text}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function DiscussionMessage(message) {
      return `
        <div class="discussion-message ${message.isPinned ? 'pinned' : ''}">
          <div class="message-header">
            <span class="message-user">
              ${message.username}
              ${message.isPinned ? '<span style="color: var(--gold);">üìå</span>' : ''}
            </span>
            <span class="message-time">${new Date(message.createdAt).toLocaleString()}</span>
          </div>
          <div class="message-text">${message.message}</div>
        </div>
      `;
    }

    window.switchTab = function(tab) {
      currentTab = tab;
      render();
    };

    window.openTeacherModal = async function(teacherId) {
      const modal = document.getElementById('teacher-modal');
      modal.innerHTML = '<div class="modal-content"><p class="text-center">Loading...</p></div>';
      modal.classList.add('active');

      const [teacherRes, reviewsRes, myReviewRes, myRatingRes] = await Promise.all([
        fetch(`${API_URL}/api/teachers/${teacherId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
        fetchReviews(teacherId),
        fetchMyReview(teacherId),
        fetchMyRating(teacherId)
      ]);

      const teacher = await teacherRes.json();
      modal.innerHTML = TeacherModal(teacher, reviewsRes, myReviewRes, myRatingRes);
    };

    window.closeTeacherModal = function() {
      document.getElementById('teacher-modal').classList.remove('active');
    };

    window.rateTeacher = async function(teacherId, rating) {
      await postRating(teacherId, rating);
      openTeacherModal(teacherId);
      loadTeachers();
    };

    window.submitReview = async function(teacherId) {
      const text = document.getElementById('review-input').value;
      if (!text.trim()) return alert('Please write a review');
      
      try {
        await postReview(teacherId, text);
        openTeacherModal(teacherId);
      } catch (error) {
        alert(error.message);
      }
    };

    window.editMyReview = async function(reviewId, teacherId) {
      const newText = prompt('Edit your review:');
      if (!newText) return;
      await updateReview(reviewId, newText);
      openTeacherModal(teacherId);
    };

    window.postNewDiscussion = async function() {
      const message = document.getElementById('discussion-input').value;
      if (!message.trim()) return alert('Please write a message');
      await postDiscussion(message);
      document.getElementById('discussion-input').value = '';
      loadDiscussions();
    };

    async function loadTeachers() {
      const teachers = await fetchTeachers();
      const grid = document.getElementById('teachers-grid');
      if (teachers.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1; text-align: center; padding: 40px;">No teachers found.</p>';
      } else {
        grid.innerHTML = teachers.map(TeacherCard).join('');
      }
    }

    async function loadDiscussions() {
      const discussions = await fetchDiscussions();
      const list = document.getElementById('discussions-list');
      if (discussions.length === 0) {
        list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">No discussions yet.</p>';
      } else {
        list.innerHTML = discussions.map(DiscussionMessage).join('');
      }
    }

    async function render() {
      const app = document.getElementById('app');

      if (!token) {
        app.innerHTML = AuthPage();
        
        document.getElementById('auth-form').onsubmit = async (e) => {
          e.preventDefault();
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          
          try {
            await login(username, password);
            render();
          } catch (error) {
            document.getElementById('auth-error').innerHTML = `<div class="alert alert-error">${error.message}</div>`;
          }
        };

        document.getElementById('register-btn').onclick = async () => {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          
          if (!username || !password) {
            document.getElementById('auth-error').innerHTML = `<div class="alert alert-error">Please fill in all fields</div>`;
            return;
          }
          
          try {
            await register(username, password);
            render();
          } catch (error) {
            document.getElementById('auth-error').innerHTML = `<div class="alert alert-error">${error.message}</div>`;
          }
        };
      } else if (!currentUser.isSetup) {
        app.innerHTML = SetupPage();
        
        const schools = await fetchSchools();
        const schoolSelect = document.getElementById('school-select');
        schoolSelect.innerHTML = '<option value="">Select a school</option>' + 
          schools.map(s => `<option value="${s._id}">${s.name}</option>`).join('');
        
        schoolSelect.onchange = async (e) => {
          const schoolId = e.target.value;
          const classSelect = document.getElementById('class-select');
          
          if (schoolId) {
            const classes = await fetchClasses(schoolId);
            classSelect.innerHTML = '<option value="">Select a class</option>' + 
              classes.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
            classSelect.disabled = false;
          } else {
            classSelect.innerHTML = '<option value="">First select a school</option>';
            classSelect.disabled = true;
          }
        };

        document.getElementById('setup-form').onsubmit = async (e) => {
          e.preventDefault();
          const schoolId = document.getElementById('school-select').value;
          const classId = document.getElementById('class-select').value;
          
          try {
            await setupAccount(schoolId, classId);
            render();
          } catch (error) {
            document.getElementById('setup-error').innerHTML = `<div class="alert alert-error">${error.message}</div>`;
          }
        };
      } else {
        app.innerHTML = MainPage();
        
        if (currentTab === 'teachers') {
          loadTeachers();
        } else {
          loadDiscussions();
        }
      }
    }

    render();
  </script>
</body>
</html>
