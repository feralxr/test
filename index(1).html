<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rate Your Teacher</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --gold: #FFD700;
      --dark-gold: #B8860B;
      --bg-dark: #0a0a0a;
      --bg-card: #1a1a1a;
      --text-light: #e0e0e0;
      --text-muted: #888;
      --border: #333;
      --success: #4ade80;
      --error: #ef4444;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: var(--bg-card);
      border-bottom: 2px solid var(--gold);
      padding: 20px 0;
      margin-bottom: 30px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    .auth-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .auth-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--gold);
      text-align: center;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-light);
      font-size: 15px;
      transition: all 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .btn {
      width: 100%;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--gold) 0%, var(--dark-gold) 100%);
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: transparent;
      color: var(--gold);
      border: 1px solid var(--gold);
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background: rgba(255, 215, 0, 0.1);
    }

    .btn-small {
      width: auto;
      padding: 8px 16px;
      font-size: 13px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      color: var(--text-muted);
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s;
      width: auto;
    }

    .tab:hover {
      color: var(--text-light);
    }

    .tab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .teachers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }

    .teacher-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }

    .teacher-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(255, 215, 0, 0.15);
      border-color: var(--gold);
    }

    .teacher-image-container {
      width: 100%;
      padding-top: 100%;
      position: relative;
      background: var(--bg-dark);
      border-bottom: 1px solid var(--border);
    }

    .teacher-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .teacher-rating-badge {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--gold);
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gold);
    }

    .teacher-info {
      padding: 20px;
    }

    .teacher-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .teacher-qualifications {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(4px);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-light);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.2s;
    }

    .close-modal:hover {
      background: var(--border);
      color: var(--gold);
    }

    .modal-header {
      display: flex;
      gap: 24px;
      margin-bottom: 30px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .modal-image-container {
      width: 150px;
      height: 150px;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    .modal-teacher-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .modal-qualifications {
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .stars-display {
      font-size: 24px;
      color: var(--gold);
      margin-bottom: 8px;
    }

    .ratings-count {
      font-size: 14px;
      color: var(--text-muted);
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .stars-input {
      display: flex;
      gap: 8px;
      font-size: 32px;
      margin-bottom: 20px;
    }

    .star {
      cursor: pointer;
      color: var(--border);
      transition: all 0.2s;
    }

    .star.active {
      color: var(--gold);
    }

    .star:hover {
      transform: scale(1.1);
    }

    .review {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .review.my-review {
      border-color: var(--gold);
      background: rgba(255, 215, 0, 0.05);
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .review-user {
      font-weight: 600;
    }

    .review-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .review-text {
      line-height: 1.6;
    }

    .discussion-message {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-left: 3px solid var(--gold);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .discussion-message.pinned {
      border-left-color: var(--dark-gold);
      background: rgba(255, 215, 0, 0.05);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .message-user {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .message-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    .message-text {
      line-height: 1.6;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      border: 1px solid;
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--error);
      color: #fca5a5;
    }

    .alert-success {
      background: rgba(74, 222, 128, 0.1);
      border-color: var(--success);
      color: #86efac;
    }

    .text-center {
      text-align: center;
    }

    .mt-2 {
      margin-top: 8px;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gold);
    }

    @media (max-width: 768px) {
      .teachers-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      }

      .modal-header {
        flex-direction: column;
      }

      .modal-image-container {
        width: 100%;
        height: 200px;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://your-render-backend-url.onrender.com';

    let token = localStorage.getItem('token');
    let currentUser = null;
    let currentTab = 'teachers';

    async function register(username, password) {
      const response = await fetch(`${API_URL}/api/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      token = data.token;
      localStorage.setItem('token', token);
      currentUser = data.user;
      return data;
    }

    async function login(username, password) {
      const response = await fetch(`${API_URL}/api/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      token = data.token;
      localStorage.setItem('token', token);
      currentUser = data.user;
      return data;
    }

    function logout() {
      token = null;
      localStorage.removeItem('token');
      currentUser = null;
      render();
    }

    async function setupAccount(schoolId, classId) {
      const response = await fetch(`${API_URL}/api/setup`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ schoolId, classId })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      currentUser.isSetup = true;
      return data;
    }

    async function fetchSchools() {
      const response = await fetch(`${API_URL}/api/schools`);
      return response.json();
    }

    async function fetchClasses(schoolId) {
      const response = await fetch(`${API_URL}/api/schools/${schoolId}/classes`);
      return response.json();
    }

    async function fetchTeachers() {
      const response = await fetch(`${API_URL}/api/teachers`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function fetchReviews(teacherId) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/reviews`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function fetchMyReview(teacherId) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/my-review`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function postReview(teacherId, text) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/reviews`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ text })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      return data;
    }

    async function updateReview(reviewId, text) {
      const response = await fetch(`${API_URL}/api/reviews/${reviewId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ text })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      return data;
    }

    async function fetchMyRating(teacherId) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/my-rating`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function postRating(teacherId, rating) {
      const response = await fetch(`${API_URL}/api/teachers/${teacherId}/ratings`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ rating })
      });
      return response.json();
    }

    async function fetchDiscussions() {
      const response = await fetch(`${API_URL}/api/discussions`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    async function postDiscussion(message) {
      const response = await fetch(`${API_URL}/api/discussions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ message })
      });
      return response.json();
    }

    function AuthPage() {
      return `
        <div class="auth-page">
          <div class="auth-card">
            <h1 class="auth-title">‚≠ê Rate Your Teacher</h1>
            <div id="auth-error"></div>
            <form id="auth-form">
              <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" required autocomplete="username" />
              </div>
              <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" required autocomplete="current-password" />
              </div>
              <button type="submit" class="btn">Login</button>
              <button type="button" class="btn btn-secondary" id="register-btn">Create Account</button>
            </form>
          </div>
        </div>
      `;
    }

    function SetupPage() {
      return `
        <div class="auth-page">
          <div class="auth-card">
            <h2 class="auth-title">Complete Setup</h2>
            <div id="setup-error"></div>
            <form id="setup-form">
              <div class="form-group">
                <label>Select Your School</label>
                <select id="school-select" required>
                  <option value="">Loading...</option>
                </select>
              </div>
              <div class="form-group">
                <label>Select Your Class</label>
                <select id="class-select" required disabled>
                  <option value="">First select a school</option>
                </select>
              </div>
              <button type="submit" class="btn">Complete Setup</button>
            </form>
          </div>
        </div>
      `;
    }

    function MainPage() {
      return `
        <div class="header">
          <div class="header-content">
            <div class="logo">‚≠ê Rate Your Teacher</div>
            <button class="btn btn-small" onclick="logout()">Logout</button>
          </div>
        </div>
        
        <div class="container">
          <div class="tabs">
            <button class="tab ${currentTab === 'teachers' ? 'active' : ''}" onclick="switchTab('teachers')">Teachers</button>
            <button class="tab ${currentTab === 'discussions' ? 'active' : ''}" onclick="switchTab('discussions')">Discussions</button>
          </div>

          <div id="teachers-tab" class="tab-content ${currentTab === 'teachers' ? 'active' : ''}">
            <div class="teachers-grid" id="teachers-grid"></div>
          </div>

          <div id="discussions-tab" class="tab-content ${currentTab === 'discussions' ? 'active' : ''}">
            <div class="form-group">
              <textarea id="discussion-input" placeholder="Share your thoughts..."></textarea>
              <button class="btn mt-2" onclick="postNewDiscussion()">Post Message</button>
            </div>
            <div id="discussions-list" style="margin-top: 24px;"></div>
          </div>
        </div>

        <div id="teacher-modal" class="modal"></div>
      `;
    }

    function TeacherCard(teacher) {
      const imageContent = teacher.imageUrl 
        ? `<img src="${teacher.imageUrl}" alt="${teacher.name}" class="teacher-image" />`
        : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">No Image</div>';
      
      return `
        <div class="teacher-card" onclick="openTeacherModal('${teacher._id}')">
          <div class="teacher-image-container">
            ${imageContent}
            <div class="teacher-rating-badge">
              <span>${teacher.averageRating.toFixed(1)}</span>
              <span>‚òÖ</span>
            </div>
          </div>
          <div class="teacher-info">
            <div class="teacher-name">${teacher.name}</div>
            <div class="teacher-qualifications">${teacher.qualifications}</div>
          </div>
        </div>
      `;
    }

    function TeacherModal(teacher, reviews, myReview, myRating) {
      const stars = '‚òÖ'.repeat(Math.round(teacher.averageRating)) + '‚òÜ'.repeat(5 - Math.round(teacher.averageRating));
      const imageContent = teacher.imageUrl 
        ? `<img src="${teacher.imageUrl}" alt="${teacher.name}" class="teacher-image" />`
        : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">No Image</div>';
      
      return `
        <div class="modal-content">
          <button class="close-modal" onclick="closeTeacherModal()">√ó</button>
          
          <div class="modal-header">
            <div class="modal-image-container">
              ${imageContent}
            </div>
            <div style="flex: 1;">
              <h2 class="modal-teacher-name">${teacher.name}</h2>
              <p class="modal-qualifications">${teacher.qualifications}</p>
              <div class="stars-display">${stars}</div>
              <p class="ratings-count">${teacher.totalRatings} rating${teacher.totalRatings !== 1 ? 's' : ''}</p>
            </div>
          </div>

          <div class="section">
            <h3 class="section-title">Your Rating</h3>
            <div class="stars-input">
              ${[1, 2, 3, 4, 5].map(i => `
                <span class="star ${i <= (myRating?.rating || 0) ? 'active' : ''}" onclick="rateTeacher('${teacher._id}', ${i})">‚òÖ</span>
              `).join('')}
            </div>
          </div>

          <div class="section">
            <h3 class="section-title">Reviews</h3>
            
            ${myReview ? `
              <div class="review my-review">
                <div class="review-header">
                  <span class="review-user">Your Review</span>
                  <button class="btn btn-small" onclick="editMyReview('${myReview._id}', '${teacher._id}')">Edit</button>
                </div>
                <div class="review-text">${myReview.text}</div>
              </div>
            ` : `
              <div class="form-group">
                <textarea id="review-input" placeholder="Write your review..."></textarea>
                <button class="btn mt-2" onclick="submitReview('${teacher._id}')">Post Review</button>
              </div>
            `}

            ${reviews.length > 0 ? '<h4 class="section-title" style="margin-top: 24px;">All Reviews</h4>' : ''}
            ${reviews.length === 0 ? '<p style="color: var(--text-muted);">No reviews yet.</p>' : ''}
            ${reviews.map(review => `
              <div class="review">
                <div class="review-header">
                  <span class="review-user">${review.username}</span>
                  <span class="review-date">${new Date(review.createdAt).toLocaleDateString()}</span>
                </div>
                <div class="review-text">${review.text}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function DiscussionMessage(message) {
      return `
        <div class="discussion-message ${message.isPinned ? 'pinned' : ''}">
          <div class="message-header">
            <span class="message-user">
              ${message.username}
              ${message.isPinned ? '<span style="color: var(--gold);">üìå</span>' : ''}
            </span>
            <span class="message-time">${new Date(message.createdAt).toLocaleString()}</span>
          </div>
          <div class="message-text">${message.message}</div>
        </div>
      `;
    }

    window.switchTab = function(tab) {
      currentTab = tab;
      render();
    };

    window.openTeacherModal = async function(teacherId) {
      const modal = document.getElementById('teacher-modal');
      modal.innerHTML = '<div class="modal-content"><p class="text-center">Loading...</p></div>';
      modal.classList.add('active');

      const [teacherRes, reviewsRes, myReviewRes, myRatingRes] = await Promise.all([
        fetch(`${API_URL}/api/teachers/${teacherId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
        fetchReviews(teacherId),
        fetchMyReview(teacherId),
        fetchMyRating(teacherId)
      ]);

      const teacher = await teacherRes.json();
      modal.innerHTML = TeacherModal(teacher, reviewsRes, myReviewRes, myRatingRes);
    };

    window.closeTeacherModal = function() {
      document.getElementById('teacher-modal').classList.remove('active');
    };

    window.rateTeacher = async function(teacherId, rating) {
      await postRating(teacherId, rating);
      openTeacherModal(teacherId);
      loadTeachers();
    };

    window.submitReview = async function(teacherId) {
      const text = document.getElementById('review-input').value;
      if (!text.trim()) return alert('Please write a review');
      
      try {
        await postReview(teacherId, text);
        openTeacherModal(teacherId);
      } catch (error) {
        alert(error.message);
      }
    };

    window.editMyReview = async function(reviewId, teacherId) {
      const newText = prompt('Edit your review:');
      if (!newText) return;
      await updateReview(reviewId, newText);
      openTeacherModal(teacherId);
    };

    window.postNewDiscussion = async function() {
      const message = document.getElementById('discussion-input').value;
      if (!message.trim()) return alert('Please write a message');
      await postDiscussion(message);
      document.getElementById('discussion-input').value = '';
      loadDiscussions();
    };

    async function loadTeachers() {
      const teachers = await fetchTeachers();
      const grid = document.getElementById('teachers-grid');
      if (teachers.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1; text-align: center; padding: 40px;">No teachers found.</p>';
      } else {
        grid.innerHTML = teachers.map(TeacherCard).join('');
      }
    }

    async function loadDiscussions() {
      const discussions = await fetchDiscussions();
      const list = document.getElementById('discussions-list');
      if (discussions.length === 0) {
        list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">No discussions yet.</p>';
      } else {
        list.innerHTML = discussions.map(DiscussionMessage).join('');
      }
    }

    async function render() {
      const app = document.getElementById('app');

      if (!token) {
        app.innerHTML = AuthPage();
        
        document.getElementById('auth-form').onsubmit = async (e) => {
          e.preventDefault();
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          
          try {
            await login(username, password);
            render();
          } catch (error) {
            document.getElementById('auth-error').innerHTML = `<div class="alert alert-error">${error.message}</div>`;
          }
        };

        document.getElementById('register-btn').onclick = async () => {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          
          if (!username || !password) {
            document.getElementById('auth-error').innerHTML = `<div class="alert alert-error">Please fill in all fields</div>`;
            return;
          }
          
          try {
            await register(username, password);
            render();
          } catch (error) {
            document.getElementById('auth-error').innerHTML = `<div class="alert alert-error">${error.message}</div>`;
          }
        };
      } else if (!currentUser.isSetup) {
        app.innerHTML = SetupPage();
        
        const schools = await fetchSchools();
        const schoolSelect = document.getElementById('school-select');
        schoolSelect.innerHTML = '<option value="">Select a school</option>' + 
          schools.map(s => `<option value="${s._id}">${s.name}</option>`).join('');
        
        schoolSelect.onchange = async (e) => {
          const schoolId = e.target.value;
          const classSelect = document.getElementById('class-select');
          
          if (schoolId) {
            const classes = await fetchClasses(schoolId);
            classSelect.innerHTML = '<option value="">Select a class</option>' + 
              classes.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
            classSelect.disabled = false;
          } else {
            classSelect.innerHTML = '<option value="">First select a school</option>';
            classSelect.disabled = true;
          }
        };

        document.getElementById('setup-form').onsubmit = async (e) => {
          e.preventDefault();
          const schoolId = document.getElementById('school-select').value;
          const classId = document.getElementById('class-select').value;
          
          try {
            await setupAccount(schoolId, classId);
            render();
          } catch (error) {
            document.getElementById('setup-error').innerHTML = `<div class="alert alert-error">${error.message}</div>`;
          }
        };
      } else {
        app.innerHTML = MainPage();
        
        if (currentTab === 'teachers') {
          loadTeachers();
        } else {
          loadDiscussions();
        }
      }
    }

    render();
  </script>
</body>
</html>
