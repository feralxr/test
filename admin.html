<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Rate Your Teacher</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Playfair+Display:wght@500;700&display=swap');

    :root {
      --ink: #05070f;
      --ink-soft: #0f1428;
      --electric: #7df9ff;
      --violet: #7c5cff;
      --magenta: #ff5cf7;
      --lime: #afff5c;
      --text: #f5f7ff;
      --muted: rgba(245, 247, 255, 0.62);
      --glass: rgba(8, 12, 30, 0.68);
      --glass-border: rgba(125, 249, 255, 0.3);
      --danger: #ff6b6b;
      --warning: #ffd166;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: radial-gradient(circle at top, rgba(124, 92, 255, 0.3), transparent 55%),
        radial-gradient(circle at 20% 20%, rgba(125, 249, 255, 0.2), transparent 45%),
        linear-gradient(140deg, #04050b 0%, #05081b 45%, #120923 100%);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      animation: gradientShift 18s ease infinite;
      background-size: 200% 200%;
    }

    .ambient-orbs {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    .ambient-orbs span {
      position: absolute;
      width: 240px;
      height: 240px;
      border-radius: 50%;
      filter: blur(25px);
      opacity: 0.35;
      animation: float 12s ease-in-out infinite;
    }

    .ambient-orbs span:nth-child(1) {
      background: var(--violet);
      top: 10%;
      left: -5%;
    }

    .ambient-orbs span:nth-child(2) {
      background: var(--electric);
      top: 60%;
      right: -4%;
      animation-delay: -4s;
    }

    .ambient-orbs span:nth-child(3) {
      background: var(--magenta);
      bottom: -10%;
      left: 25%;
      animation-delay: -7s;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px 80px;
    }

    h1, h2, h3 {
      font-family: 'Playfair Display', serif;
      color: var(--text);
      text-shadow: 0 12px 40px rgba(124, 92, 255, 0.2);
    }

    h1 {
      text-align: center;
      font-size: clamp(2.4rem, 4vw, 3.4rem);
      margin: 24px 0 32px;
      letter-spacing: 0.08em;
    }

    .glass-panel {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      box-shadow: 0 30px 60px rgba(5, 7, 15, 0.7);
      backdrop-filter: blur(22px);
    }

    .auth-container {
      max-width: 420px;
      margin: 120px auto;
      padding: 44px;
      animation: popIn 0.8s ease;
    }

    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.02em;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 14px;
      background: rgba(6, 10, 24, 0.9);
      border: 1px solid rgba(125, 249, 255, 0.25);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(125, 249, 255, 0.2);
      border-color: var(--electric);
      transform: translateY(-1px);
    }

    button {
      padding: 12px 26px;
      background: linear-gradient(135deg, var(--electric), var(--violet));
      color: #05070f;
      border: none;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      position: relative;
      overflow: hidden;
    }

    button::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.35), transparent);
      transform: translateX(-120%);
      transition: transform 0.5s ease;
    }

    button:hover::after {
      transform: translateX(120%);
    }

    button:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 10px 30px rgba(125, 249, 255, 0.35);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff9f9f, #ff4d6d);
      color: #12050a;
    }

    .btn-secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(125, 249, 255, 0.4);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      margin-bottom: 20px;
    }

    .top-bar .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(125, 249, 255, 0.15);
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 22px;
      background: rgba(8, 12, 30, 0.7);
      color: var(--muted);
      border: 1px solid transparent;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .tab.active {
      color: var(--text);
      border-color: rgba(125, 249, 255, 0.5);
      box-shadow: 0 0 20px rgba(125, 249, 255, 0.25);
    }

    .tab:hover {
      color: var(--text);
      border-color: rgba(124, 92, 255, 0.4);
    }

    .tab-content {
      display: none;
      animation: fadeUp 0.5s ease;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      padding: 22px;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(5, 7, 15, 0.65);
      box-shadow: inset 0 0 0 1px rgba(125, 249, 255, 0.15);
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid rgba(125, 249, 255, 0.08);
    }

    th {
      background: rgba(125, 249, 255, 0.08);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 12px;
    }

    tr {
      transition: all 0.3s ease;
    }

    tr:hover {
      background: rgba(125, 249, 255, 0.06);
      transform: scale(1.01);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .action-buttons button {
      padding: 8px 16px;
      font-size: 12px;
    }

    .error, .success {
      padding: 14px 18px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    .error {
      background: rgba(255, 77, 109, 0.16);
      color: #ffb3c7;
      border-color: rgba(255, 77, 109, 0.4);
    }

    .success {
      background: rgba(175, 255, 92, 0.16);
      color: #d5ffb8;
      border-color: rgba(175, 255, 92, 0.4);
    }

    .toggle-section {
      padding: 24px;
      margin-bottom: 30px;
    }

    .toggle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid rgba(125, 249, 255, 0.12);
    }

    .toggle-item:last-child {
      border-bottom: none;
    }

    .toggle-switch {
      position: relative;
      width: 62px;
      height: 32px;
      background: rgba(5, 7, 15, 0.8);
      border: 1px solid rgba(125, 249, 255, 0.4);
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-switch.active {
      background: linear-gradient(135deg, var(--electric), var(--violet));
    }

    .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: var(--text);
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .toggle-switch.active .toggle-slider {
      left: 35px;
      background: #05070f;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      padding: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .stat-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(125, 249, 255, 0.2), transparent 60%);
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .stat-card:hover::after {
      opacity: 1;
    }

    .stat-number {
      font-size: 36px;
      font-weight: 700;
      color: var(--electric);
    }

    .stat-label {
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(3, 5, 12, 0.85);
      z-index: 1000;
      overflow-y: auto;
      backdrop-filter: blur(6px);
      padding: 20px;
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      max-width: 640px;
      margin: 60px auto;
      padding: 32px;
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 16px;
      right: 20px;
      font-size: 28px;
      color: var(--text);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    @keyframes popIn {
      from { transform: translateY(20px) scale(0.96); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 rgba(125, 249, 255, 0); }
      50% { box-shadow: 0 0 20px rgba(125, 249, 255, 0.3); }
    }

    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
        align-items: flex-start;
      }

      .tabs {
        overflow-x: auto;
      }

      table {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="ambient-orbs" aria-hidden="true">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <div id="app"></div>

  <script>
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://your-render-backend-url.onrender.com';

    let token = localStorage.getItem('adminToken');
    let currentTab = 'dashboard';
    let schools = [];
    let classes = [];
    let teachers = [];
    let reviews = [];
    let users = [];
    let discussions = [];
    let config = { anonymousReviews: false, hideTeacherImages: false };

    // Auth
    async function adminLogin(secret) {
      const response = await fetch(`${API_URL}/api/admin/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ secret })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      token = data.token;
      localStorage.setItem('adminToken', token);
      return data;
    }

    function logout() {
      token = null;
      localStorage.removeItem('adminToken');
      render();
    }

    // API Functions
    async function fetchConfig() {
      const response = await fetch(`${API_URL}/api/admin/config`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      config = await response.json();
    }

    async function updateConfig(updates) {
      const response = await fetch(`${API_URL}/api/admin/config`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(updates)
      });
      config = await response.json();
    }

    async function fetchSchools() {
      const response = await fetch(`${API_URL}/api/schools`);
      schools = await response.json();
    }

    async function createSchool(name) {
      const response = await fetch(`${API_URL}/api/admin/schools`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ name })
      });
      return response.json();
    }

    async function deleteSchool(id) {
      await fetch(`${API_URL}/api/admin/schools/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    }

    async function fetchClasses() {
      const response = await fetch(`${API_URL}/api/schools`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const schoolsList = await response.json();
      
      classes = [];
      for (const school of schoolsList) {
        const classesRes = await fetch(`${API_URL}/api/schools/${school._id}/classes`);
        const schoolClasses = await classesRes.json();
        classes.push(...schoolClasses.map(c => ({ ...c, schoolName: school.name })));
      }
    }

    async function createClass(name, schoolId) {
      const response = await fetch(`${API_URL}/api/admin/classes`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ name, schoolId })
      });
      return response.json();
    }

    async function deleteClass(id) {
      await fetch(`${API_URL}/api/admin/classes/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    }

    async function fetchTeachers() {
      const response = await fetch(`${API_URL}/api/admin/teachers`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      teachers = await response.json();
    }

    async function createTeacher(data) {
      const response = await fetch(`${API_URL}/api/admin/teachers`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });
      return response.json();
    }

    async function updateTeacher(id, data) {
      const response = await fetch(`${API_URL}/api/admin/teachers/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });
      return response.json();
    }

    async function deleteTeacher(id) {
      await fetch(`${API_URL}/api/admin/teachers/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    }

    async function fetchReviews() {
      const response = await fetch(`${API_URL}/api/admin/reviews`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      reviews = await response.json();
    }

    async function deleteReview(id) {
      await fetch(`${API_URL}/api/admin/reviews/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    }

    async function fetchUsers() {
      const response = await fetch(`${API_URL}/api/admin/users`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      users = await response.json();
    }

    async function deleteUser(id) {
      await fetch(`${API_URL}/api/admin/users/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    }

    async function resetUserPassword(id, newPassword) {
      await fetch(`${API_URL}/api/admin/users/${id}/reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ newPassword })
      });
    }

    async function fetchDiscussions() {
      const response = await fetch(`${API_URL}/api/discussions`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      discussions = await response.json();
    }

    async function togglePin(id) {
      await fetch(`${API_URL}/api/admin/discussions/${id}/pin`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    }

    async function deleteDiscussion(id) {
      await fetch(`${API_URL}/api/admin/discussions/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    }

    // UI Functions
    window.switchTab = function(tab) {
      currentTab = tab;
      render();
    };

    window.toggleConfig = async function(key) {
      const newValue = !config[key];
      await updateConfig({ [key]: newValue });
      render();
    };

    window.openModal = function(modalId) {
      document.getElementById(modalId).classList.add('active');
    };

    window.closeModal = function(modalId) {
      document.getElementById(modalId).classList.remove('active');
    };

    window.showAddSchoolModal = function() {
      const modal = document.getElementById('modal');
      modal.innerHTML = `
        <div class="modal-content glass-panel">
          <button class="close-modal" onclick="closeModal('modal')">Ã—</button>
          <h2>Add School</h2>
          <form onsubmit="handleAddSchool(event)">
            <div class="form-group">
              <label>School Name</label>
              <input type="text" id="school-name" required />
            </div>
            <button type="submit">Add School</button>
          </form>
        </div>
      `;
      modal.classList.add('active');
    };

    window.handleAddSchool = async function(e) {
      e.preventDefault();
      const name = document.getElementById('school-name').value;
      await createSchool(name);
      closeModal('modal');
      await fetchSchools();
      render();
    };

    window.handleDeleteSchool = async function(id) {
      if (!confirm('Delete this school? This will also delete all associated classes and teachers.')) return;
      await deleteSchool(id);
      await fetchSchools();
      render();
    };

    window.showAddClassModal = function() {
      const modal = document.getElementById('modal');
      modal.innerHTML = `
        <div class="modal-content glass-panel">
          <button class="close-modal" onclick="closeModal('modal')">Ã—</button>
          <h2>Add Class</h2>
          <form onsubmit="handleAddClass(event)">
            <div class="form-group">
              <label>School</label>
              <select id="class-school" required>
                <option value="">Select School</option>
                ${schools.map(s => `<option value="${s._id}">${s.name}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Class Name</label>
              <input type="text" id="class-name" required />
            </div>
            <button type="submit">Add Class</button>
          </form>
        </div>
      `;
      modal.classList.add('active');
    };

    window.handleAddClass = async function(e) {
      e.preventDefault();
      const name = document.getElementById('class-name').value;
      const schoolId = document.getElementById('class-school').value;
      await createClass(name, schoolId);
      closeModal('modal');
      await fetchClasses();
      render();
    };

    window.handleDeleteClass = async function(id) {
      if (!confirm('Delete this class? This will also delete all associated teachers.')) return;
      await deleteClass(id);
      await fetchClasses();
      render();
    };

    window.showAddTeacherModal = function() {
      const modal = document.getElementById('modal');
      modal.innerHTML = `
        <div class="modal-content glass-panel">
          <button class="close-modal" onclick="closeModal('modal')">Ã—</button>
          <h2>Add Teacher</h2>
          <form onsubmit="handleAddTeacher(event)">
            <div class="form-group">
              <label>School</label>
              <select id="teacher-school" required onchange="updateClassOptions()">
                <option value="">Select School</option>
                ${schools.map(s => `<option value="${s._id}">${s.name}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Class</label>
              <select id="teacher-class" required disabled>
                <option value="">First select a school</option>
              </select>
            </div>
            <div class="form-group">
              <label>Teacher Name</label>
              <input type="text" id="teacher-name" required />
            </div>
            <div class="form-group">
              <label>Qualifications</label>
              <textarea id="teacher-qualifications" required></textarea>
            </div>
            
            <div class="form-group">
              <label>Image Option</label>
              <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button type="button" class="btn-secondary" onclick="toggleImageOption('url')" id="btn-url">Use URL</button>
                <button type="button" class="btn-secondary" onclick="toggleImageOption('upload')" id="btn-upload">Upload Image</button>
              </div>
            </div>

            <div class="form-group" id="url-option" style="display: none;">
              <label>Image URL</label>
              <input type="text" id="teacher-image-url" placeholder="https://..." />
            </div>

            <div class="form-group" id="upload-option" style="display: none;">
              <label>Upload Image</label>
              <input type="file" id="teacher-image-file" accept="image/*" />
              <div id="upload-progress" style="margin-top: 10px; display: none;">
                <div style="color: #FFD700;">Uploading...</div>
              </div>
              <div id="upload-preview" style="margin-top: 10px; display: none;">
                <img id="preview-img" style="max-width: 200px; border: 2px solid #FFD700; border-radius: 8px;" />
              </div>
            </div>

            <button type="submit" id="submit-teacher-btn">Add Teacher</button>
          </form>
        </div>
      `;
      modal.classList.add('active');
      
      // Default to URL option
      toggleImageOption('url');
    };

    window.toggleImageOption = function(option) {
      const urlOption = document.getElementById('url-option');
      const uploadOption = document.getElementById('upload-option');
      const btnUrl = document.getElementById('btn-url');
      const btnUpload = document.getElementById('btn-upload');
      
      if (option === 'url') {
        urlOption.style.display = 'block';
        uploadOption.style.display = 'none';
        btnUrl.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
        btnUrl.style.color = '#000';
        btnUpload.style.background = 'transparent';
        btnUpload.style.color = '#FFD700';
        document.getElementById('teacher-image-url').required = true;
        document.getElementById('teacher-image-file').required = false;
      } else {
        urlOption.style.display = 'none';
        uploadOption.style.display = 'block';
        btnUpload.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
        btnUpload.style.color = '#000';
        btnUrl.style.background = 'transparent';
        btnUrl.style.color = '#FFD700';
        document.getElementById('teacher-image-url').required = false;
        document.getElementById('teacher-image-file').required = true;
      }
    };

    window.updateClassOptions = async function() {
      const schoolId = document.getElementById('teacher-school').value;
      const classSelect = document.getElementById('teacher-class');
      
      if (schoolId) {
        const response = await fetch(`${API_URL}/api/schools/${schoolId}/classes`);
        const schoolClasses = await response.json();
        classSelect.innerHTML = '<option value="">Select Class</option>' + 
          schoolClasses.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
        classSelect.disabled = false;
      } else {
        classSelect.innerHTML = '<option value="">First select a school</option>';
        classSelect.disabled = true;
      }
    };

    window.handleAddTeacher = async function(e) {
      e.preventDefault();
      const submitBtn = document.getElementById('submit-teacher-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding...';
      
      try {
        let imageUrl = document.getElementById('teacher-image-url').value;
        const imageFile = document.getElementById('teacher-image-file').files[0];
        
        // If file is selected, upload it first
        if (imageFile) {
          document.getElementById('upload-progress').style.display = 'block';
          
          const formData = new FormData();
          formData.append('image', imageFile);
          
          const uploadResponse = await fetch(`${API_URL}/api/admin/upload-image`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });
          
          if (!uploadResponse.ok) {
            throw new Error('Image upload failed');
          }
          
          const uploadData = await uploadResponse.json();
          imageUrl = uploadData.imageUrl;
          
          document.getElementById('upload-progress').style.display = 'none';
        }
        
        if (!imageUrl) {
          throw new Error('Please provide an image URL or upload an image');
        }
        
        const data = {
          name: document.getElementById('teacher-name').value,
          qualifications: document.getElementById('teacher-qualifications').value,
          imageUrl: imageUrl,
          classId: document.getElementById('teacher-class').value,
          schoolId: document.getElementById('teacher-school').value
        };
        
        await createTeacher(data);
        closeModal('modal');
        await fetchTeachers();
        render();
      } catch (error) {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Teacher';
      }
    };

    window.showEditTeacherModal = function(teacher) {
      const modal = document.getElementById('modal');
      modal.innerHTML = `
        <div class="modal-content glass-panel">
          <button class="close-modal" onclick="closeModal('modal')">Ã—</button>
          <h2>Edit Teacher</h2>
          <form onsubmit="handleEditTeacher(event, '${teacher._id}')">
            <div class="form-group">
              <label>Teacher Name</label>
              <input type="text" id="edit-teacher-name" value="${teacher.name}" required />
            </div>
            <div class="form-group">
              <label>Qualifications</label>
              <textarea id="edit-teacher-qualifications" required>${teacher.qualifications}</textarea>
            </div>
            
            <div class="form-group">
              <label>Current Image</label>
              <img src="${teacher.imageUrl}" style="max-width: 200px; border: 2px solid #FFD700; border-radius: 8px; display: block; margin-bottom: 10px;" />
            </div>

            <div class="form-group">
              <label>Update Image</label>
              <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button type="button" class="btn-secondary" onclick="toggleEditImageOption('url')" id="edit-btn-url">Use URL</button>
                <button type="button" class="btn-secondary" onclick="toggleEditImageOption('upload')" id="edit-btn-upload">Upload New</button>
                <button type="button" class="btn-secondary" onclick="toggleEditImageOption('keep')" id="edit-btn-keep">Keep Current</button>
              </div>
            </div>

            <div class="form-group" id="edit-url-option" style="display: none;">
              <label>New Image URL</label>
              <input type="text" id="edit-teacher-image-url" placeholder="https://..." />
            </div>

            <div class="form-group" id="edit-upload-option" style="display: none;">
              <label>Upload New Image</label>
              <input type="file" id="edit-teacher-image-file" accept="image/*" />
              <div id="edit-upload-progress" style="margin-top: 10px; display: none;">
                <div style="color: #FFD700;">Uploading...</div>
              </div>
            </div>

            <input type="hidden" id="edit-current-image" value="${teacher.imageUrl}" />
            
            <button type="submit" id="submit-edit-teacher-btn">Update Teacher</button>
          </form>
        </div>
      `;
      modal.classList.add('active');
      
      // Default to keep current
      toggleEditImageOption('keep');
    };

    window.toggleEditImageOption = function(option) {
      const urlOption = document.getElementById('edit-url-option');
      const uploadOption = document.getElementById('edit-upload-option');
      const btnUrl = document.getElementById('edit-btn-url');
      const btnUpload = document.getElementById('edit-btn-upload');
      const btnKeep = document.getElementById('edit-btn-keep');
      
      // Reset all buttons
      [btnUrl, btnUpload, btnKeep].forEach(btn => {
        btn.style.background = 'transparent';
        btn.style.color = '#FFD700';
      });
      
      if (option === 'url') {
        urlOption.style.display = 'block';
        uploadOption.style.display = 'none';
        btnUrl.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
        btnUrl.style.color = '#000';
      } else if (option === 'upload') {
        urlOption.style.display = 'none';
        uploadOption.style.display = 'block';
        btnUpload.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
        btnUpload.style.color = '#000';
      } else {
        urlOption.style.display = 'none';
        uploadOption.style.display = 'none';
        btnKeep.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
        btnKeep.style.color = '#000';
      }
    };

    window.handleEditTeacher = async function(e, id) {
      e.preventDefault();
      const submitBtn = document.getElementById('submit-edit-teacher-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Updating...';
      
      try {
        let imageUrl = document.getElementById('edit-teacher-image-url').value;
        const imageFile = document.getElementById('edit-teacher-image-file').files[0];
        const currentImage = document.getElementById('edit-current-image').value;
        
        // If file is selected, upload it first
        if (imageFile) {
          document.getElementById('edit-upload-progress').style.display = 'block';
          
          const formData = new FormData();
          formData.append('image', imageFile);
          
          const uploadResponse = await fetch(`${API_URL}/api/admin/upload-image`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });
          
          if (!uploadResponse.ok) {
            throw new Error('Image upload failed');
          }
          
          const uploadData = await uploadResponse.json();
          imageUrl = uploadData.imageUrl;
          
          document.getElementById('edit-upload-progress').style.display = 'none';
        }
        
        // If no new image provided, keep current
        if (!imageUrl) {
          imageUrl = currentImage;
        }
        
        const data = {
          name: document.getElementById('edit-teacher-name').value,
          qualifications: document.getElementById('edit-teacher-qualifications').value,
          imageUrl: imageUrl
        };
        
        await updateTeacher(id, data);
        closeModal('modal');
        await fetchTeachers();
        render();
      } catch (error) {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Update Teacher';
      }
    };

    window.handleDeleteTeacher = async function(id) {
      if (!confirm('Delete this teacher? This will also delete all reviews and ratings.')) return;
      await deleteTeacher(id);
      await fetchTeachers();
      render();
    };

    window.handleDeleteReview = async function(id) {
      if (!confirm('Delete this review?')) return;
      await deleteReview(id);
      await fetchReviews();
      render();
    };

    window.handleDeleteUser = async function(id) {
      if (!confirm('Delete this user? This will also delete all their reviews, ratings, and discussions.')) return;
      await deleteUser(id);
      await fetchUsers();
      render();
    };

    window.handleResetPassword = async function(id) {
      const newPassword = prompt('Enter new password:');
      if (!newPassword) return;
      await resetUserPassword(id, newPassword);
      alert('Password reset successfully');
    };

    window.handleTogglePin = async function(id) {
      await togglePin(id);
      await fetchDiscussions();
      render();
    };

    window.handleDeleteDiscussion = async function(id) {
      if (!confirm('Delete this discussion message?')) return;
      await deleteDiscussion(id);
      await fetchDiscussions();
      render();
    };

    async function render() {
      const app = document.getElementById('app');

      if (!token) {
        app.innerHTML = `
          <div class="auth-container glass-panel">
            <h2 style="text-align: center; margin-bottom: 30px;">Admin Login</h2>
            <div id="auth-error"></div>
            <form id="auth-form">
              <div class="form-group">
                <label>Admin Secret</label>
                <input type="password" id="secret" required />
              </div>
              <button type="submit">Login</button>
            </form>
          </div>
        `;

        document.getElementById('auth-form').onsubmit = async (e) => {
          e.preventDefault();
          const secret = document.getElementById('secret').value;
          
          try {
            await adminLogin(secret);
            render();
          } catch (error) {
            document.getElementById('auth-error').innerHTML = `<div class="error">${error.message}</div>`;
          }
        };
        return;
      }

      // Load all data
      await Promise.all([
        fetchConfig(),
        fetchSchools(),
        fetchClasses(),
        fetchTeachers(),
        fetchReviews(),
        fetchUsers(),
        fetchDiscussions()
      ]);

      app.innerHTML = `
        <div class="container">
          <div class="top-bar glass-panel">
            <div class="chip">âš¡ Command Center</div>
            <button onclick="logout()">Logout</button>
          </div>
          <h1>Admin Dashboard</h1>

          <div class="tabs glass-panel">
            <button class="tab ${currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab ${currentTab === 'schools' ? 'active' : ''}" onclick="switchTab('schools')">Schools</button>
            <button class="tab ${currentTab === 'classes' ? 'active' : ''}" onclick="switchTab('classes')">Classes</button>
            <button class="tab ${currentTab === 'teachers' ? 'active' : ''}" onclick="switchTab('teachers')">Teachers</button>
            <button class="tab ${currentTab === 'reviews' ? 'active' : ''}" onclick="switchTab('reviews')">Reviews</button>
            <button class="tab ${currentTab === 'users' ? 'active' : ''}" onclick="switchTab('users')">Users</button>
            <button class="tab ${currentTab === 'discussions' ? 'active' : ''}" onclick="switchTab('discussions')">Discussions</button>
            <button class="tab ${currentTab === 'settings' ? 'active' : ''}" onclick="switchTab('settings')">Settings</button>
          </div>

          ${currentTab === 'dashboard' ? `
            <div class="tab-content active">
              <h2>System Overview</h2>
              <div class="stats-grid">
                <div class="stat-card glass-panel">
                  <div class="stat-number">${schools.length}</div>
                  <div class="stat-label">Schools</div>
                </div>
                <div class="stat-card glass-panel">
                  <div class="stat-number">${classes.length}</div>
                  <div class="stat-label">Classes</div>
                </div>
                <div class="stat-card glass-panel">
                  <div class="stat-number">${teachers.length}</div>
                  <div class="stat-label">Teachers</div>
                </div>
                <div class="stat-card glass-panel">
                  <div class="stat-number">${reviews.length}</div>
                  <div class="stat-label">Reviews</div>
                </div>
                <div class="stat-card glass-panel">
                  <div class="stat-number">${users.length}</div>
                  <div class="stat-label">Users</div>
                </div>
                <div class="stat-card glass-panel">
                  <div class="stat-number">${discussions.length}</div>
                  <div class="stat-label">Discussions</div>
                </div>
              </div>
            </div>
          ` : ''}

          ${currentTab === 'schools' ? `
            <div class="tab-content active">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Schools Management</h2>
                <button onclick="showAddSchoolModal()">Add School</button>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Created At</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${schools.map(school => `
                    <tr>
                      <td>${school.name}</td>
                      <td>${new Date(school.createdAt).toLocaleDateString()}</td>
                      <td>
                        <button class="btn-danger" onclick="handleDeleteSchool('${school._id}')">Delete</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}

          ${currentTab === 'classes' ? `
            <div class="tab-content active">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Classes Management</h2>
                <button onclick="showAddClassModal()">Add Class</button>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>School</th>
                    <th>Class Name</th>
                    <th>Created At</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${classes.map(cls => `
                    <tr>
                      <td>${cls.schoolName}</td>
                      <td>${cls.name}</td>
                      <td>${new Date(cls.createdAt).toLocaleDateString()}</td>
                      <td>
                        <button class="btn-danger" onclick="handleDeleteClass('${cls._id}')">Delete</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}

          ${currentTab === 'teachers' ? `
            <div class="tab-content active">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Teachers Management</h2>
                <button onclick="showAddTeacherModal()">Add Teacher</button>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>School</th>
                    <th>Class</th>
                    <th>Rating</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${teachers.map(teacher => `
                    <tr>
                      <td>${teacher.name}</td>
                      <td>${teacher.school?.name || 'N/A'}</td>
                      <td>${teacher.class?.name || 'N/A'}</td>
                      <td>${teacher.averageRating.toFixed(1)} â˜… (${teacher.totalRatings})</td>
                      <td>
                        <div class="action-buttons">
                          <button onclick='showEditTeacherModal(${JSON.stringify(teacher)})'>Edit</button>
                          <button class="btn-danger" onclick="handleDeleteTeacher('${teacher._id}')">Delete</button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}

          ${currentTab === 'reviews' ? `
            <div class="tab-content active">
              <h2>Reviews Management</h2>
              <table>
                <thead>
                  <tr>
                    <th>Teacher</th>
                    <th>User</th>
                    <th>Review</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${reviews.map(review => `
                    <tr>
                      <td>${review.teacher?.name || 'N/A'}</td>
                      <td>${review.username}</td>
                      <td style="max-width: 300px;">${review.text}</td>
                      <td>${new Date(review.createdAt).toLocaleDateString()}</td>
                      <td>
                        <button class="btn-danger" onclick="handleDeleteReview('${review._id}')">Delete</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}

          ${currentTab === 'users' ? `
            <div class="tab-content active">
              <h2>Users Management</h2>
              <table>
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>School</th>
                    <th>Class</th>
                    <th>Joined</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${users.map(user => `
                    <tr>
                      <td>${user.username}</td>
                      <td>${user.school?.name || 'Not set'}</td>
                      <td>${user.class?.name || 'Not set'}</td>
                      <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                      <td>
                        <div class="action-buttons">
                          <button onclick="handleResetPassword('${user._id}')">Reset Password</button>
                          <button class="btn-danger" onclick="handleDeleteUser('${user._id}')">Delete</button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}

          ${currentTab === 'discussions' ? `
            <div class="tab-content active">
              <h2>Discussions Management</h2>
              <table>
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Message</th>
                    <th>Date</th>
                    <th>Pinned</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${discussions.map(msg => `
                    <tr>
                      <td>${msg.username}</td>
                      <td style="max-width: 400px;">${msg.message}</td>
                      <td>${new Date(msg.createdAt).toLocaleString()}</td>
                      <td>${msg.isPinned ? 'ðŸ“Œ Yes' : 'No'}</td>
                      <td>
                        <div class="action-buttons">
                          <button onclick="handleTogglePin('${msg._id}')">${msg.isPinned ? 'Unpin' : 'Pin'}</button>
                          <button class="btn-danger" onclick="handleDeleteDiscussion('${msg._id}')">Delete</button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}

          ${currentTab === 'settings' ? `
            <div class="tab-content active">
              <h2>System Settings</h2>
              
              <div class="toggle-section glass-panel">
                <h3 style="margin-bottom: 20px;">Master Toggles</h3>
                
                <div class="toggle-item">
                  <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">Anonymous Reviews</div>
                    <div style="font-size: 14px; color: #CCC;">Hide usernames from all reviews</div>
                  </div>
                  <div class="toggle-switch ${config.anonymousReviews ? 'active' : ''}" onclick="toggleConfig('anonymousReviews')">
                    <div class="toggle-slider"></div>
                  </div>
                </div>

                <div class="toggle-item">
                  <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">Hide Teacher Images</div>
                    <div style="font-size: 14px; color: #CCC;">Display black sections instead of teacher images</div>
                  </div>
                  <div class="toggle-switch ${config.hideTeacherImages ? 'active' : ''}" onclick="toggleConfig('hideTeacherImages')">
                    <div class="toggle-slider"></div>
                  </div>
                </div>
              </div>

              <div class="card glass-panel">
                <h3>Important Notes</h3>
                <ul style="margin-top: 15px; padding-left: 20px; color: #CCC; line-height: 1.8;">
                  <li>These toggles affect all users immediately</li>
                  <li>Anonymous reviews will hide usernames but preserve review content</li>
                  <li>Hidden teacher images will show as black sections while maintaining the layout</li>
                  <li>To change the admin secret, update it directly in the database</li>
                </ul>
              </div>
            </div>
          ` : ''}
        </div>

        <div id="modal" class="modal"></div>
      `;
    }

    render();
  </script>
</body>
</html>
